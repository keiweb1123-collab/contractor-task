<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>One-Tap Reporter</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <link rel="stylesheet" href="style.css?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
</head>
<!-- ... -->
<!-- PWA Install Prompt Logic could go here -->
<script src="app.js?v=18"></script>

<body>

    <div class="container">
        <header>
            <h1>CONSTRUCTION LOG</h1>
            <p>One-Tap Daily Reporting</p>
        </header>

        <!-- Unit Selection Grid -->
        <div id="unit-grid" class="grid-container">
            <!-- Units generated by JS -->
        </div>

        <!-- Input Section -->
        <div id="input-section" class="hidden input-card-fullscreen">
            <div class="sticky-header">
                <div>
                    <h2 id="selected-unit-display" style="font-weight:900; font-size:1.4rem;">Unit 1</h2>
                </div>
                <button class="close-btn" onclick="resetSelection()">âœ•</button>
            </div>

            <!-- Tab Switching -->
            <div class="sticky-tabs">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('photo')">ğŸ“· Camera</button>
                    <button class="tab-btn" onclick="switchTab('task')">ğŸ“ Tasks (<span
                            id="task-count">0</span>)</button>
                </div>
            </div>

            <div class="scrollable-content">
                <!-- PHOTO TAB -->
                <div id="photo-tab" class="tab-content">
                    <div class="form-group">
                        <span class="label">Watermark Options</span>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <input type="checkbox" id="watermark-floor-check" style="width:20px; height:20px;">
                            <label for="watermark-floor-check" style="font-weight:600; color:#374151;">Include Floor
                                Text</label>
                        </div>
                        <div class="chip-group small" id="photo-floor-options">
                            <button class="chip" onclick="selectPhotoFloor('Building')">Building</button>
                            <button class="chip" onclick="selectPhotoFloor('GF')">GF</button>
                            <button class="chip" onclick="selectPhotoFloor('1F')">1F</button>
                            <button class="chip" onclick="selectPhotoFloor('2F')">2F</button>
                            <button class="chip" onclick="selectPhotoFloor('3F')">3F</button>
                            <button class="chip" onclick="selectPhotoFloor('RF')">RF</button>
                        </div>
                    </div>

                    <!-- Camera Start Button -->
                    <div style="text-align:center; margin-bottom:16px;">
                        <button id="start-camera-btn"
                            style="background:white; color:#111; padding:12px 20px; border-radius:99px; font-weight:700; border:none; box-shadow:0 2px 8px rgba(0,0,0,0.1);"
                            onclick="startCamera()">ğŸ“· Open Camera</button>
                    </div>

                    <!-- Preview Gallery -->
                    <div id="preview-gallery" class="preview-gallery" style="margin-top:10px;"></div>
                </div>

                <!-- FULLSCREEN CAMERA OVERLAY -->
                <div id="camera-overlay" class="hidden"
                    style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:5000; display:flex; flex-direction:column;">
                    <video id="camera-stream" autoplay playsinline muted
                        style="flex:1; width:100%; height:100%; object-fit:contain;"></video>
                    <canvas id="camera-canvas" class="hidden"></canvas>

                    <!-- Close Button (top-left) -->
                    <button onclick="closeCameraOverlay()"
                        style="position:absolute; top:16px; left:16px; z-index:5010; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:44px; height:44px; font-size:22px; backdrop-filter:blur(5px); display:flex; align-items:center; justify-content:center;">âœ•</button>

                    <!-- Orientation Permission Button (iOS) -->
                    <button id="btn-orientation" onclick="requestOrientationPermission()"
                        title="Enable auto-rotation for landscape photos"
                        style="position:absolute; top:16px; right:16px; z-index:5010; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:44px; height:44px; font-size:20px; backdrop-filter:blur(5px); display:flex; align-items:center; justify-content:center;">ğŸ”ƒ</button>

                    <!-- Camera Selection Dropdown -->
                    <div style="position:absolute; top:70px; left:16px; z-index:5010;">
                        <select id="camera-select" onchange="manualSelectCamera()"
                            style="background:rgba(0,0,0,0.6); color:white; border:1px solid #666; padding:8px; border-radius:8px; font-size:14px; max-width:200px;">
                            <option value="">Auto Select</option>
                        </select>
                    </div>

                    <!-- Bottom Controls -->
                    <div class="camera-controls-bottom">

                        <!-- Front/Back Switch -->
                        <button onclick="switchCameraFace()" class="camera-side-btn"
                            style="background:rgba(255,255,255,0.2); backdrop-filter:blur(5px); border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center; border:none; color:white; font-size:20px;">ğŸ”„</button>

                        <button class="btn-shutter" onclick="capturePhoto()"></button>

                        <!-- Wide/Normal Toggle (hidden if not available) -->
                        <button id="btn-wide-toggle" onclick="toggleWideMode()" class="camera-side-btn hidden"
                            style="background:rgba(255,255,255,0.2); backdrop-filter:blur(5px); border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center; border:none; color:white; font-size:14px; font-weight:700;">1x</button>
                    </div>
                </div>

                <!-- TASK TAB -->
                <div id="task-tab" class="tab-content hidden">
                    <div class="form-group">
                        <span class="label">Current Tasks</span>
                        <div id="task-list-display" class="task-list-display">
                            <p class="empty-msg">No tasks yet.</p>
                        </div>

                        <div class="separator" style="margin-top: 0">Structure</div>
                        <div class="task-grid">
                            <button class="task-btn" onclick="openTaskOption('Excavation', 'excavation_targets')">ğŸšœ
                                Excavation</button>
                            <button class="task-btn"
                                onclick="openTaskOption('Rebar Installation', 'rebar_struct_targets')">ğŸ— Rebar
                                Installation</button>
                            <button class="task-btn"
                                onclick="openTaskOption('Rebar fabrication', 'rebar_fab_targets')">âš™ï¸
                                Rebar Fab</button>
                            <button class="task-btn" onclick="openTaskOption('Casting concrete', 'casting_targets')">ğŸ—
                                Casting</button>
                            <button class="task-btn" onclick="openTaskOption('Scaffolding installation', 'floor')">ğŸªœ
                                Scaffolding</button>
                            <button class="task-btn"
                                onclick="openTaskOption('Form work installation', 'formwork_targets')">ğŸªµ
                                Form Work</button>
                            <button class="task-btn"
                                onclick="openTaskOption('Demolishing formwork', 'demolishing_targets')">ğŸ”¨
                                Demolishing</button>
                            <button class="task-btn"
                                onclick="openTaskOption('Lean concrete', 'lean_concrete_targets')">ğŸª¨
                                Lean Concrete</button>

                            <div class="separator">Finishing</div>

                            <button class="task-btn" onclick="openTaskOption('Brick wall installation', 'floor')">ğŸ§±
                                Brick Wall</button>
                            <button class="task-btn" onclick="openTaskOption('Plastering', 'floor_lift_gf')">ğŸ¨
                                Plastering</button>
                            <button class="task-btn" onclick="openTaskOption('Skim coat', 'floor')">ğŸ–Œ Skim
                                Coat</button>
                            <button class="task-btn" onclick="openTaskOption('Installation of MEP work', 'floor')">âš¡ï¸
                                MEP Work</button>
                            <button class="task-btn" onclick="openTaskOption('Water piping installation', 'floor')">ğŸš°
                                Water Piping</button>
                            <button class="task-btn" onclick="addTaskDirect('General Cleaning')">ğŸ§¹ Cleaning</button>

                            <div class="separator">Roof & Others</div>

                            <button class="task-btn" onclick="addTaskDirect('Parapet Installation')">ğŸ  Parapet</button>
                            <button class="task-btn" onclick="addTaskDirect('Trus Installation for roof')">ğŸ“ Roof
                                Trus</button>
                            <button class="task-btn" onclick="addTaskDirect('Safety scaffolding/net installation')">ğŸ¦º
                                Safety Net</button>
                        </div>

                        <!-- Custom Task Input -->
                        <div class="custom-task-box">
                            <span class="label">Custom Input</span>
                            <div class="input-row">
                                <input type="text" id="custom-task-input" placeholder="Type manual task..."
                                    class="custom-task-margin">
                                <button class="btn-small" onclick="addCustomTask()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sticky Footer for Save -->
            <div class="sticky-footer">
                <button class="btn-primary" onclick="saveAndClose()">Save & Close</button>
            </div>

        </div>

        <!-- Task Option Modal -->
        <div id="option-modal" class="modal hidden">
            <div class="modal-content popup-box">
                <h3 id="modal-title" style="font-weight:900; margin-bottom:10px; color: black;">Select Option</h3>
                <p class="modal-subtitle">Choose one or multiple</p>
                <div id="modal-options" class="modal-options-grid">
                    <!-- Dynamic buttons -->
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeModal()">Back</button>
                    <button class="btn-primary" onclick="confirmModalSelection()">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-container" class="reports-container"></div>
    </div>

    <!-- Debug: Global Error Handler -->
    <script>
        window.onerror = function (msg, src, line, col, err) {
            alert("JS Error: " + msg + "\n(Line: " + line + ")");
        };
    </script>
    <!-- PWA Install Prompt Logic could go here -->
    <script src="app.js?v=26"></script>
    <script>
        // Register Service Worker if we wanted offline support, but for now simple manifest is enough for "Add to Home Screen"
    </script>

</body>
